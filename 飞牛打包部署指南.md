# FlyPic 飞牛 NAS 打包部署指南

本指南介绍如何将 FlyPic 打包成飞牛 fnOS 应用包（.fpk）并部署到飞牛 NAS。

## 前置要求

### 开发环境（Windows/Mac/Linux）
- Node.js 18+
- Docker Desktop（用于编译 Linux 版本依赖）

### 飞牛 NAS
- fnOS 系统
- fnpack 命令行工具（通过 `npm install -g fnpack` 安装）

## 一、构建应用

### 方法一：使用 Docker 构建（推荐）

此方法会自动编译 Linux 版本的原生模块（Sharp、better-sqlite3），上传到飞牛后可直接使用。

```bash
# 确保 Docker Desktop 正在运行
node scripts/build-fpk-docker.js
```

构建完成后，`flypic` 目录将包含：
- `app/server/` - 后端代码和前端构建产物
- `app/server/node_modules/` - Linux 版本的依赖（约 50MB）
- `app/ui/` - 应用 UI 配置
- `cmd/` - 生命周期脚本
- `wizard/` - 安装向导配置
- `manifest` - 应用清单

### 方法二：仅构建代码（需在飞牛上安装依赖）

```bash
node scripts/build-fpk.js
```

此方法不包含 node_modules，需要在飞牛 NAS 上手动安装依赖。

## 二、上传到飞牛 NAS

将整个 `flypic` 文件夹上传到飞牛 NAS，可以使用：
- 飞牛文件管理器
- SFTP/SCP
- SMB 共享

建议上传到用户目录，如：`/vol1/1000/flypic`

## 三、打包 .fpk 文件

SSH 登录到飞牛 NAS，执行：

```bash
# 进入应用目录
cd /vol1/1000/flypic

# 打包应用
fnpack build
```

成功后会生成 `flypic_x.x.x_all.fpk` 文件。

## 四、安装应用

### 方法一：通过飞牛应用中心安装
1. 打开飞牛 fnOS 桌面
2. 进入「应用中心」→「手动安装」
3. 选择生成的 `.fpk` 文件
4. 按照安装向导完成安装

### 方法二：命令行安装
```bash
fnpack install flypic_x.x.x_all.fpk
```

## 五、配置应用

安装完成后，首次使用需要：

1. **配置授权目录**：在飞牛应用设置中，为 FlyPic 添加素材库文件夹的访问权限

2. **添加素材库**：打开 FlyPic，添加素材库时输入完整路径，如：
   - `/vol1/1000/图片库`
   - `/vol2/photos`

## 目录结构说明

```
flypic/
├── app/
│   ├── server/           # 应用服务器
│   │   ├── server.js     # 主入口
│   │   ├── package.json
│   │   ├── node_modules/ # 依赖（Docker 构建时包含）
│   │   ├── public/       # 前端静态文件
│   │   ├── routes/       # API 路由
│   │   ├── database/     # 数据库模块
│   │   └── utils/        # 工具函数
│   └── ui/
│       ├── config        # UI 配置
│       └── images/       # 应用图标
├── cmd/
│   ├── main              # 启动脚本
│   ├── install_init      # 安装前脚本
│   ├── install_callback  # 安装后脚本
│   └── ...               # 其他生命周期脚本
├── wizard/
│   └── install           # 安装向导配置
├── config/
│   └── resource          # 资源配置
├── manifest              # 应用清单
├── ICON.PNG              # 应用图标 256x256
└── ICON_256.PNG          # 应用图标 256x256
```

## 常见问题

### Q: 应用启动失败，显示"异常退出"
A: 检查以下几点：
1. 确保使用 Docker 构建方法，包含 Linux 版本的 node_modules
2. 检查应用日志，查看具体错误信息
3. 确保端口 15002 未被占用

### Q: 无法访问素材库文件夹
A: 在飞牛应用设置中配置授权目录，添加素材库路径的访问权限。

### Q: 如何更新应用？
A: 
1. 重新构建：`node scripts/build-fpk-docker.js`
2. 上传到飞牛并打包：`fnpack build`
3. 在应用中心选择「更新」或重新安装

### Q: 如何查看应用日志？
A: 在飞牛系统日志中查看，或 SSH 登录后查看应用日志文件。

## 开发调试

本地开发时，可以分别启动前后端：

```bash
# 终端 1：启动后端
cd backend
npm install
npm run dev

# 终端 2：启动前端
cd frontend
npm install
npm run dev
```

访问 http://localhost:5173 进行开发调试。
