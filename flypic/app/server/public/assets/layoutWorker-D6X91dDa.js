(function(){"use strict";let c={containerWidth:0,targetHeight:0,imageCount:0,rows:[],pendingRow:[],pendingRowWidthSum:0};function W(n,o,l,i,s){const a=(n.length-1)*16;let e=(o-a)/l;i&&n.length<3&&(e=Math.min(e,1.2));const t=s*e;return n.map(u=>({...u,calculatedWidth:u.originalWidth*e,calculatedHeight:t}))}function A(n,o,l){if(!n.length||!o)return{rows:[],pendingRow:[],pendingRowWidthSum:0};const i=[];let s=[],a=0;for(let h=0;h<n.length;h++){const e=n[h],t=e.width/e.height,u=l*t;s.push({...e,originalWidth:u,aspectRatio:t}),a+=u;const r=(s.length-1)*16,g=a+r,p=h===n.length-1;let d=!1;if(p)d=!0;else if(g>=o*.95)d=!0;else{const w=n[h+1];if(w){const R=w.width/w.height,G=l*R;a+G+s.length*16>o*1.2&&(d=!0)}}if(d){const w=W(s,o,a,p,l);i.push(w),s=[],a=0}}return{rows:i,pendingRow:s,pendingRowWidthSum:a}}function x(n,o,l,i,s,a){if(!n.length){if(s.length>0){const r=W(s,o,a,!0,l);return{rows:[...i,r],pendingRow:[],pendingRowWidthSum:0}}return{rows:i,pendingRow:[],pendingRowWidthSum:0}}const h=[...i];let e=[...s],t=a;const u=i.reduce((r,g)=>r+g.length,0)+s.length+n.length;for(let r=0;r<n.length;r++){const g=n[r],p=g.width/g.height,d=l*p;e.push({...g,originalWidth:d,aspectRatio:p}),t+=d;const w=(e.length-1)*16,R=t+w,S=i.reduce((f,C)=>f+C.length,0)+h.length-i.length+e.length>=u;let m=!1;if(S)m=!0;else if(R>=o*.95)m=!0;else{const f=n[r+1];if(f){const C=f.width/f.height,I=l*C;t+I+e.length*16>o*1.2&&(m=!0)}}if(m){const f=W(e,o,t,S,l);h.push(f),e=[],t=0}}return{rows:h,pendingRow:e,pendingRowWidthSum:t}}function P(){c={containerWidth:0,targetHeight:0,imageCount:0,rows:[],pendingRow:[],pendingRowWidthSum:0}}self.onmessage=function(n){const{images:o,containerWidth:l,targetHeight:i,requestId:s,incremental:a,reset:h}=n.data;if(h){P(),self.postMessage({requestId:s,reset:!0});return}const e=performance.now();let t;const u=a&&c.containerWidth===l&&c.targetHeight===i&&o.length>c.imageCount;if(u){const g=o.slice(c.imageCount),p=c.rows.slice(0,-1),d=c.rows[c.rows.length-1]||[];t=x(g,l,i,p,c.pendingRow.length>0?c.pendingRow:d,c.pendingRowWidthSum>0?c.pendingRowWidthSum:d.reduce((w,R)=>w+R.originalWidth,0))}else t=A(o,l,i);c={containerWidth:l,targetHeight:i,imageCount:o.length,rows:t.rows,pendingRow:t.pendingRow,pendingRowWidthSum:t.pendingRowWidthSum};const r=performance.now()-e;self.postMessage({rows:t.rows,requestId:s,duration:r,imageCount:o.length,rowCount:t.rows.length,incremental:u})}})();
